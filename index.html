<!DOCTYPE html>
<html lang="en">
<head>
    <title>Create Token | SolMint</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.0/lib/index.iife.min.js"></script>
    <script src="src/js/wallet.js"></script>
    <script src="src/js/token.js"></script>
</head>
<body class="bg-gray-50 font-sans">

<!-- Header -->
<header class="bg-blue-600 text-white p-6">
    <div class="flex justify-center items-center flex-col">
        <h1 class="text-3xl font-bold">SolMint</h1>
        <nav class="mt-4 flex justify-center space-x-8">
            <a href="index.html" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300">
                Create Token
            </a>
            <a href="create-liquidity.html" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300">
                Create Liquidity Pool
            </a>
            <button id="connectWalletButton" onclick="showWalletModal()" 
                class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">
                Connect Wallet
            </button>
            <select id="networkSelect" onchange="updateNetwork()" class="bg-white text-blue-600 border rounded-md py-2 px-4 hover:border-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-300">
                <option value="devnet">Devnet</option>
                <option value="testnet">Testnet</option>
                <option value="mainnet">Mainnet</option>
            </select>
        </nav>
    </div>
</header>

<!-- Wallet Selector Modal -->
<div id="walletModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
        <h3 class="text-xl font-bold mb-4">Select Wallet</h3>
        <div class="space-y-4">
            <button onclick="connectSpecificWallet('phantom')" 
                    class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center space-x-2">
                <img src="https://phantom.app/img/phantom-logo.svg" class="w-6 h-6" alt="Phantom">
                <span>Phantom</span>
            </button>
            <button onclick="connectSpecificWallet('solflare')" 
                    class="w-full bg-orange-600 text-white py-3 px-4 rounded-lg hover:bg-orange-700 transition-colors flex items-center justify-center space-x-2">
                <img src="https://solflare.com/assets/logo.svg" class="w-6 h-6" alt="Solflare">
                <span>Solflare</span>
            </button>
        </div>
        <button onclick="closeWalletModal()" 
                class="mt-4 w-full py-2 px-4 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
            Cancel
        </button>
    </div>
</div>

<!-- Main Content -->
<main class="p-8 grid grid-cols-1 md:grid-cols-2 gap-8">
    <section class="bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold mb-6">Create Your Token</h2>
        <form id="createTokenForm" onsubmit="event.preventDefault(); createToken();" class="hidden">
            <label for="tokenName" class="block text-sm font-medium">Token Name</label>
            <input type="text" id="tokenName" class="w-full p-3 border rounded-md mb-4" required>
            
            <label for="tokenSymbol" class="block text-sm font-medium">Token Symbol</label>
            <input type="text" id="tokenSymbol" class="w-full p-3 border rounded-md mb-4" required>
            
            <label for="totalSupply" class="block text-sm font-medium">Total Supply</label>
            <input type="number" id="totalSupply" class="w-full p-3 border rounded-md mb-4" required>
            
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <h3 class="text-lg font-semibold mb-2">Fee Preview</h3>
                <div id="feeBreakdown" class="text-sm">
                    <div class="flex justify-between mb-1">
                        <span>Base Token Creation:</span>
                        <span>0.01 SOL</span>
                    </div>
                    <div id="revokeMintFee" class="flex justify-between mb-1 text-gray-400">
                        <span>Revoke Mint Authority:</span>
                        <span>0.005 SOL</span>
                    </div>
                    <div id="freezeFee" class="flex justify-between mb-1 text-gray-400">
                        <span>Freeze Authority:</span>
                        <span>0.005 SOL</span>
                    </div>
                    <div id="decimalsFee" class="flex justify-between mb-1 text-gray-400">
                        <span>Custom Decimals:</span>
                        <span>0.005 SOL</span>
                    </div>
                    <div id="metadataFee" class="flex justify-between mb-1 text-gray-400">
                        <span>Metadata:</span>
                        <span>0.01 SOL</span>
                    </div>
                    <div class="border-t border-gray-300 mt-2 pt-2 flex justify-between font-semibold">
                        <span>Total Fee:</span>
                        <span id="totalFee">0.01 SOL</span>
                    </div>
                </div>
            </div>

            <div class="space-y-4 mb-6">
                <div class="flex items-center group relative">
                    <input type="checkbox" id="revokeMint" class="mr-2" onchange="updateFeePreview()">
                    <label for="revokeMint" class="text-sm font-medium">Revoke Mint Authority</label>
                    <div class="hidden group-hover:block absolute left-full ml-2 bg-gray-800 text-white p-2 rounded text-xs w-48">
                        Permanently revoke the ability to mint more tokens after creation
                    </div>
                </div>

                <div class="flex items-center group relative">
                    <input type="checkbox" id="freezeAuthority" class="mr-2" onchange="updateFeePreview()">
                    <label for="freezeAuthority" class="text-sm font-medium">Freeze Authority</label>
                    <div class="hidden group-hover:block absolute left-full ml-2 bg-gray-800 text-white p-2 rounded text-xs w-48">
                        Enable the ability to freeze token accounts
                    </div>
                </div>

                <div class="flex items-center group relative">
                    <input type="checkbox" id="customDecimals" class="mr-2" onchange="updateFeePreview()">
                    <label for="customDecimals" class="text-sm font-medium">Custom Decimals</label>
                    <div class="hidden group-hover:block absolute left-full ml-2 bg-gray-800 text-white p-2 rounded text-xs w-48">
                        Set custom decimal places for your token
                    </div>
                </div>

                <div class="flex items-center group relative">
                    <input type="checkbox" id="metadata" class="mr-2" onchange="updateFeePreview()">
                    <label for="metadata" class="text-sm font-medium">Add Metadata</label>
                    <div class="hidden group-hover:block absolute left-full ml-2 bg-gray-800 text-white p-2 rounded text-xs w-48">
                        Add on-chain metadata to your token (image, description, etc.)
                    </div>
                </div>
            </div>
            
            <button id="createTokenButton" class="bg-blue-600 text-white py-3 rounded-md">
                Create Token
            </button>
        </form>
        <div id="walletRequiredMessage" class="text-lg text-gray-700">
            Please connect your wallet to create a token.
        </div>
    </section>
    <!-- Token Creation Description Section -->
<section class="bg-white p-6 rounded-lg shadow-lg">
    <h2 class="text-2xl font-bold mb-6">What is a Token?</h2>
    <p class="text-sm text-gray-700 mb-4">
        A token is a digital asset that represents ownership, value, or access to a specific service or product. In the context of SolanaMint, you can create custom tokens for various purposes like decentralized finance (DeFi), gaming, or as part of a tokenized ecosystem.
    </p>
    <h3 class="text-lg font-semibold mb-2">Key Features of Your Token</h3>
    <ul class="list-disc pl-5 text-sm text-gray-700">
        <li>Customizable token name and symbol</li>
        <li>Ability to set total supply and control token minting</li>
        <li>Manage permissions like freeze and revoke minting authority</li>
    </ul>
    <h3 class="text-lg font-semibold mb-2 mt-4">Why Create a Token?</h3>
    <p class="text-sm text-gray-700">
        Tokens are the backbone of blockchain projects, enabling the creation of decentralized ecosystems, rewards systems, and incentivized networks. By creating your own token, you can engage with new possibilities in blockchain technology.
    </p>
</section>
</main>

<!-- Footer -->
<footer class="bg-blue-600 text-white p-6 text-center mt-auto">
    <div class="container mx-auto">
        <p>&copy; 2024 SolMint | <a href="https://t.me/jinwoo5385" class="text-blue-300">Contact us</a></p>
    </div>
</footer>

<script>
    // Initialize wallet manager and connection
    async function initializeConnection(network) {
        try {
            await window.walletManager.initialize(network);
            console.log('Connection initialized successfully');
        } catch (error) {
            console.error('Failed to initialize connection:', error);
        }
    }

    async function autoConnectWallet(walletName) {
        try {
            await connectSpecificWallet(walletName, true);
        } catch (error) {
            console.error('Auto-connect failed:', error);
        }
    }

    function showWalletModal() {
        document.getElementById('walletModal').classList.remove('hidden');
    }

    function closeWalletModal() {
        document.getElementById('walletModal').classList.add('hidden');
    }

    async function connectSpecificWallet(walletName, isAutoConnect = false) {
        try {
            const wallet = await window.walletManager.connectWallet(walletName);
            
            if (wallet) {
                const publicKey = wallet.publicKey.toString();
                document.getElementById('connectWalletButton').textContent = 
                    publicKey.slice(0, 4) + '...' + publicKey.slice(-4);
                
                if (!isAutoConnect) {
                    closeWalletModal();
                }
                
                // Update UI state
                document.getElementById('createTokenForm').classList.remove('hidden');
                document.getElementById('walletRequiredMessage').classList.add('hidden');
            }
        } catch (error) {
            console.error('Failed to connect wallet:', error);
            alert('Failed to connect wallet: ' + error.message);
        }
    }

    async function disconnectWallet() {
        try {
            await window.walletManager.disconnect();
            document.getElementById('connectWalletButton').textContent = 'Connect Wallet';
            document.getElementById('createTokenForm').classList.add('hidden');
            document.getElementById('walletRequiredMessage').classList.remove('hidden');
        } catch (error) {
            console.error('Failed to disconnect:', error);
            alert('Failed to disconnect wallet: ' + error.message);
        }
    }

    async function updateNetwork() {
        const networkSelect = document.getElementById('networkSelect');
        const newNetwork = networkSelect.value;
        const oldNetwork = localStorage.getItem('selectedNetwork') || 'devnet';
        
        // Disable UI during network switch
        networkSelect.disabled = true;
        const loadingIndicator = document.createElement('div');
        loadingIndicator.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg z-50';
        loadingIndicator.textContent = 'Switching network...';
        document.body.appendChild(loadingIndicator);
        
        try {
            // Initialize new network connection
            await window.walletManager.initialize(newNetwork);
            
            // If wallet is connected, try to switch its network
            if (window.walletManager.wallet) {
                try {
                    await window.walletManager.switchNetwork(newNetwork);
                    console.log(`Successfully switched to ${newNetwork}`);
                } catch (error) {
                    console.error('Failed to switch wallet network:', error);
                    // Show manual switch instruction
                    const manualSwitchMsg = document.createElement('div');
                    manualSwitchMsg.className = 'fixed top-4 right-4 bg-yellow-500 text-white px-4 py-2 rounded-lg z-50';
                    manualSwitchMsg.textContent = `Please switch your wallet to ${newNetwork} manually`;
                    document.body.appendChild(manualSwitchMsg);
                    setTimeout(() => manualSwitchMsg.remove(), 5000);
                    throw error;
                }
            }
            
            // Save network preference only after successful switch
            localStorage.setItem('selectedNetwork', newNetwork);
            networkSelect.dataset.currentNetwork = newNetwork;
            
            // Update UI to show success
            const successMsg = document.createElement('div');
            successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg z-50';
            successMsg.textContent = `Successfully switched to ${newNetwork}`;
            document.body.appendChild(successMsg);
            setTimeout(() => successMsg.remove(), 3000);
            
        } catch (error) {
            console.error('Network switch failed:', error);
            
            // Revert UI
            networkSelect.value = oldNetwork;
            
            // Show error message
            const errorMsg = document.createElement('div');
            errorMsg.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg z-50';
            errorMsg.textContent = `Failed to switch network: ${error.message}`;
            document.body.appendChild(errorMsg);
            setTimeout(() => errorMsg.remove(), 5000);
            
        } finally {
            // Re-enable UI
            networkSelect.disabled = false;
            loadingIndicator.remove();
        }
    }

    // Initialize connection on page load
    window.addEventListener('load', async () => {
        try {
            const savedNetwork = localStorage.getItem('selectedNetwork') || 'devnet';
            const networkSelect = document.getElementById('networkSelect');
            networkSelect.value = savedNetwork;
            networkSelect.dataset.currentNetwork = savedNetwork;
            
            await window.walletManager.initialize(savedNetwork);
            
            // Try to auto-connect to last used wallet
            const lastWallet = localStorage.getItem('lastUsedWallet');
            if (lastWallet) {
                try {
                    await window.walletManager.connectWallet(lastWallet);
                } catch (error) {
                    console.error('Auto-connect failed:', error);
                }
            }
        } catch (error) {
            console.error('Initialization failed:', error);
        }
    });

    async function createToken() {
        try {
            const tokenName = document.getElementById('tokenName').value;
            const tokenSymbol = document.getElementById('tokenSymbol').value;
            const totalSupply = parseFloat(document.getElementById('totalSupply').value);
            const decimals = document.getElementById('customDecimals').checked ? 9 : 6;
            
            if (!window.walletManager.isConnected()) {
                throw new Error('Please connect your wallet first');
            }

            // Show loading state
            const createButton = document.getElementById('createTokenButton');
            const originalText = createButton.textContent;
            createButton.disabled = true;
            createButton.textContent = 'Creating Token...';

            // Create token manager if not exists
            if (!window.tokenManager) {
                window.tokenManager = new TokenManager(window.walletManager);
            }

            // Create token
            const result = await window.tokenManager.createToken(
                tokenName,
                tokenSymbol,
                decimals,
                totalSupply
            );

            // Show success message
            const successMsg = document.createElement('div');
            successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg z-50';
            successMsg.textContent = `Token created successfully! Mint address: ${result.mint}`;
            document.body.appendChild(successMsg);
            setTimeout(() => successMsg.remove(), 5000);

            // Reset form
            document.getElementById('createTokenForm').reset();

        } catch (error) {
            console.error('Token creation failed:', error);
            
            // Show error message
            const errorMsg = document.createElement('div');
            errorMsg.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg z-50';
            errorMsg.textContent = `Failed to create token: ${error.message}`;
            document.body.appendChild(errorMsg);
            setTimeout(() => errorMsg.remove(), 5000);
            
        } finally {
            // Reset button state
            const createButton = document.getElementById('createTokenButton');
            createButton.disabled = false;
            createButton.textContent = 'Create Token';
        }
    }

    function updateFeePreview() {
        const revokeMint = document.getElementById('revokeMint').checked;
        const freezeAuthority = document.getElementById('freezeAuthority').checked;
        const customDecimals = document.getElementById('customDecimals').checked;
        const metadata = document.getElementById('metadata').checked;

        // Update fee line items visibility
        document.getElementById('revokeMintFee').className = 
            `flex justify-between mb-1 ${revokeMint ? 'text-gray-900' : 'text-gray-400'}`;
        document.getElementById('freezeFee').className = 
            `flex justify-between mb-1 ${freezeAuthority ? 'text-gray-900' : 'text-gray-400'}`;
        document.getElementById('decimalsFee').className = 
            `flex justify-between mb-1 ${customDecimals ? 'text-gray-900' : 'text-gray-400'}`;
        document.getElementById('metadataFee').className = 
            `flex justify-between mb-1 ${metadata ? 'text-gray-900' : 'text-gray-400'}`;

        // Calculate total fee
        let totalFee = 0.01;
        if (revokeMint) totalFee += 0.005;
        if (freezeAuthority) totalFee += 0.005;
        if (customDecimals) totalFee += 0.005;
        if (metadata) totalFee += 0.01;

        document.getElementById('totalFee').textContent = `${totalFee.toFixed(3)} SOL`;
    }

    // Add event listeners for fee preview updates
    document.addEventListener('DOMContentLoaded', () => {
        updateFeePreview();
    });
</script>

<div id="modal-container"></div>
</body>
</html>