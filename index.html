<!DOCTYPE html>
<html lang="en">
<head>
    <title>Create Token | SolMint</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.0/lib/index.iife.min.js"></script>
</head>
<body class="bg-gray-50 font-sans">

<!-- Header -->
<header class="bg-blue-600 text-white p-6">
    <div class="flex justify-center items-center flex-col">
        <h1 class="text-3xl font-bold">SolMint</h1>
        <nav class="mt-4 flex justify-center space-x-8">
            <a href="index.html" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300">
                Create Token
            </a>
            <a href="create-liquidity.html" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300">
                Create Liquidity Pool
            </a>
            <button id="connectWalletButton" onclick="showWalletModal()" 
                class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">
                Connect Wallet
            </button>
            <select id="networkSelect" onchange="updateNetwork()" class="bg-white text-blue-600 border rounded-md py-2 px-4 hover:border-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-300">
                <option value="devnet">Devnet</option>
                <option value="testnet">Testnet</option>
                <option value="mainnet">Mainnet</option>
            </select>
        </nav>
    </div>
</header>

<!-- Wallet Selector Modal -->
<div id="walletModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
        <h3 class="text-xl font-bold mb-4">Select Wallet</h3>
        <div class="space-y-4">
            <button onclick="connectSpecificWallet('phantom')" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 flex items-center justify-center">
                <img src="https://phantom.app/img/phantom-logo.svg" class="w-6 h-6 mr-2" alt="Phantom">
                Phantom
            </button>
            <button onclick="connectSpecificWallet('solflare')" class="w-full bg-orange-600 text-white py-2 px-4 rounded-md hover:bg-orange-700 flex items-center justify-center">
                <img src="https://solflare.com/favicon.ico" class="w-6 h-6 mr-2" alt="Solflare">
                Solflare
            </button>
        </div>
        <button onclick="closeWalletModal()" class="mt-4 w-full border border-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-100">
            Cancel
        </button>
    </div>
</div>

<!-- Main Content -->
<main class="p-8 grid grid-cols-1 md:grid-cols-2 gap-8">
    <section class="bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold mb-6">Create Your Token</h2>
        <form id="createTokenForm" onsubmit="event.preventDefault(); createToken();">
            <label for="tokenName" class="block text-sm font-medium">Token Name</label>
            <input type="text" id="tokenName" class="w-full p-3 border rounded-md mb-4" required>
            
            <label for="tokenSymbol" class="block text-sm font-medium">Token Symbol</label>
            <input type="text" id="tokenSymbol" class="w-full p-3 border rounded-md mb-4" required>
            
            <label for="totalSupply" class="block text-sm font-medium">Total Supply</label>
            <input type="number" id="totalSupply" class="w-full p-3 border rounded-md mb-4" required>
            
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <h3 class="text-lg font-semibold mb-2">Fee Preview</h3>
                <div id="feeBreakdown" class="text-sm">
                    <div class="flex justify-between mb-1">
                        <span>Base Token Creation:</span>
                        <span>0.01 SOL</span>
                    </div>
                    <div id="revokeMintFee" class="flex justify-between mb-1 text-gray-400">
                        <span>Revoke Mint Authority:</span>
                        <span>0.005 SOL</span>
                    </div>
                    <div id="freezeFee" class="flex justify-between mb-1 text-gray-400">
                        <span>Freeze Authority:</span>
                        <span>0.005 SOL</span>
                    </div>
                    <div id="decimalsFee" class="flex justify-between mb-1 text-gray-400">
                        <span>Custom Decimals:</span>
                        <span>0.005 SOL</span>
                    </div>
                    <div id="metadataFee" class="flex justify-between mb-1 text-gray-400">
                        <span>Metadata:</span>
                        <span>0.01 SOL</span>
                    </div>
                    <div class="border-t border-gray-300 mt-2 pt-2 flex justify-between font-semibold">
                        <span>Total Fee:</span>
                        <span id="totalFee">0.01 SOL</span>
                    </div>
                </div>
            </div>

            <div class="space-y-4 mb-6">
                <div class="flex items-center group relative">
                    <input type="checkbox" id="revokeMint" class="mr-2" onchange="updateFeePreview()">
                    <label for="revokeMint" class="text-sm font-medium">Revoke Mint Authority</label>
                    <div class="hidden group-hover:block absolute left-full ml-2 bg-gray-800 text-white p-2 rounded text-xs w-48">
                        Permanently revoke the ability to mint more tokens after creation
                    </div>
                </div>

                <div class="flex items-center group relative">
                    <input type="checkbox" id="freezeAuthority" class="mr-2" onchange="updateFeePreview()">
                    <label for="freezeAuthority" class="text-sm font-medium">Freeze Authority</label>
                    <div class="hidden group-hover:block absolute left-full ml-2 bg-gray-800 text-white p-2 rounded text-xs w-48">
                        Enable the ability to freeze token accounts
                    </div>
                </div>

                <div class="flex items-center group relative">
                    <input type="checkbox" id="customDecimals" class="mr-2" onchange="updateFeePreview()">
                    <label for="customDecimals" class="text-sm font-medium">Custom Decimals</label>
                    <div class="hidden group-hover:block absolute left-full ml-2 bg-gray-800 text-white p-2 rounded text-xs w-48">
                        Set custom decimal places for your token
                    </div>
                </div>

                <div class="flex items-center group relative">
                    <input type="checkbox" id="metadata" class="mr-2" onchange="updateFeePreview()">
                    <label for="metadata" class="text-sm font-medium">Add Metadata</label>
                    <div class="hidden group-hover:block absolute left-full ml-2 bg-gray-800 text-white p-2 rounded text-xs w-48">
                        Add on-chain metadata to your token (image, description, etc.)
                    </div>
                </div>
            </div>
            
            <button id="createTokenButton" class="bg-blue-600 text-white py-3 rounded-md">
                Create Token
            </button>
        </form>
    </section>
    <!-- Token Creation Description Section -->
<section class="bg-white p-6 rounded-lg shadow-lg">
    <h2 class="text-2xl font-bold mb-6">What is a Token?</h2>
    <p class="text-sm text-gray-700 mb-4">
        A token is a digital asset that represents ownership, value, or access to a specific service or product. In the context of SolanaMint, you can create custom tokens for various purposes like decentralized finance (DeFi), gaming, or as part of a tokenized ecosystem.
    </p>
    <h3 class="text-lg font-semibold mb-2">Key Features of Your Token</h3>
    <ul class="list-disc pl-5 text-sm text-gray-700">
        <li>Customizable token name and symbol</li>
        <li>Ability to set total supply and control token minting</li>
        <li>Manage permissions like freeze and revoke minting authority</li>
    </ul>
    <h3 class="text-lg font-semibold mb-2 mt-4">Why Create a Token?</h3>
    <p class="text-sm text-gray-700">
        Tokens are the backbone of blockchain projects, enabling the creation of decentralized ecosystems, rewards systems, and incentivized networks. By creating your own token, you can engage with new possibilities in blockchain technology.
    </p>
</section>
</main>

<!-- Footer -->
<footer class="bg-blue-600 text-white p-6 text-center mt-auto">
    <div class="container mx-auto">
        <p>&copy; 2024 SolMint | <a href="https://t.me/jinwoo5385" class="text-blue-300">Contact us</a></p>
    </div>
</footer>

<script>
    // Initialize Solana connection and state
    let connection;
    let walletPublicKey = null;
    let selectedNetwork = localStorage.getItem('selectedNetwork') || 'devnet';
    let currentWallet = null;
    let isConnecting = false;

    // Initialize connection on page load
    window.addEventListener('load', async () => {
        initializeConnection(selectedNetwork);
        document.getElementById('networkSelect').value = selectedNetwork;
        
        // Auto-connect to last used wallet if available
        const lastUsedWallet = localStorage.getItem('lastUsedWallet');
        if (lastUsedWallet) {
            await autoConnectWallet(lastUsedWallet);
        }
    });

    function initializeConnection(network) {
        try {
            const networks = {
                'devnet': 'https://api.devnet.solana.com',
                'testnet': 'https://api.testnet.solana.com',
                'mainnet': 'https://api.mainnet-beta.solana.com'
            };
            connection = new solanaWeb3.Connection(networks[network], 'confirmed');
            console.log(`Connected to ${network}`);
        } catch (error) {
            console.error('Failed to initialize connection:', error);
            alert('Failed to connect to network. Please try again.');
        }
    }

    async function autoConnectWallet(walletName) {
        if (window.solana && walletName === 'phantom' || window.solflare && walletName === 'solflare') {
            await connectSpecificWallet(walletName, true);
        }
    }

    function showWalletModal() {
        if (!isConnecting) {
            document.getElementById('walletModal').classList.remove('hidden');
        }
    }

    function closeWalletModal() {
        document.getElementById('walletModal').classList.add('hidden');
    }

    async function connectSpecificWallet(walletName, isAutoConnect = false) {
        if (isConnecting) return;
        isConnecting = true;
        
        try {
            let wallet;
            if (walletName === 'phantom') {
                if (!window.solana || !window.solana.isPhantom) {
                    if (!isAutoConnect) {
                        alert("Phantom wallet is not installed. You will be redirected to install it.");
                        window.open("https://phantom.app/", "_blank");
                    }
                    return;
                }
                wallet = window.solana;
            } else if (walletName === 'solflare') {
                if (!window.solflare) {
                    if (!isAutoConnect) {
                        alert("Solflare wallet is not installed. You will be redirected to install it.");
                        window.open("https://solflare.com/", "_blank");
                    }
                    return;
                }
                wallet = window.solflare;
            }

            // Check if wallet is already connected
            if (currentWallet === wallet && walletPublicKey) {
                closeWalletModal();
                return;
            }

            // Disconnect any existing wallet connection
            if (currentWallet) {
                await disconnectWallet();
            }

            currentWallet = wallet;
            const resp = await wallet.connect();
            walletPublicKey = resp.publicKey.toString();
            
            // Update button text and state
            const connectButton = document.getElementById('connectWalletButton');
            connectButton.textContent = `${walletName.charAt(0).toUpperCase() + walletName.slice(1)} (${walletPublicKey.slice(0, 4)}...${walletPublicKey.slice(-4)})`;
            connectButton.onclick = disconnectWallet;

            // Ensure wallet is on the correct network
            await switchWalletNetwork(selectedNetwork);
            closeWalletModal();

            // Save wallet preference
            localStorage.setItem('lastUsedWallet', walletName);

            // Add wallet change listener
            wallet.on('accountChanged', async () => {
                await disconnectWallet();
                await connectSpecificWallet(walletName);
            });

        } catch (err) {
            console.error("Error connecting to wallet:", err);
            if (err.code === 4001) {
                if (!isAutoConnect) {
                    alert("Wallet connection was rejected by the user.");
                }
            } else {
                alert("Failed to connect to wallet: " + err.message);
            }
            currentWallet = null;
            walletPublicKey = null;
        } finally {
            isConnecting = false;
        }
    }

    async function disconnectWallet() {
        try {
            if (currentWallet) {
                await currentWallet.disconnect();
                localStorage.removeItem('lastUsedWallet');
            }
        } catch (err) {
            console.error("Error disconnecting wallet:", err);
        } finally {
            // Always reset the state and UI, even if disconnect fails
            walletPublicKey = null;
            currentWallet = null;
            const connectButton = document.getElementById('connectWalletButton');
            connectButton.textContent = "Connect Wallet";
            connectButton.onclick = showWalletModal;
        }
    }

    async function updateNetwork() {
        const newNetwork = document.getElementById('networkSelect').value;
        
        try {
            // Save network preference
            localStorage.setItem('selectedNetwork', newNetwork);
            selectedNetwork = newNetwork;
            
            // Reinitialize connection
            initializeConnection(newNetwork);
            
            // If wallet is connected, switch its network
            if (currentWallet && walletPublicKey) {
                await switchWalletNetwork(newNetwork);
            }
            
            console.log(`Successfully switched to ${newNetwork}`);
        } catch (error) {
            console.error('Failed to switch network:', error);
            alert('Failed to switch network. Please try again.');
        }
    }

    async function switchWalletNetwork(network) {
        if (!currentWallet) return;

        try {
            const networkConfig = {
                devnet: { url: 'https://api.devnet.solana.com', name: 'devnet' },
                testnet: { url: 'https://api.testnet.solana.com', name: 'testnet' },
                mainnet: { url: 'https://api.mainnet-beta.solana.com', name: 'mainnet-beta' }
            };

            if (currentWallet.setNetwork) {
                await currentWallet.setNetwork(networkConfig[network].name);
            } else {
                console.log('Wallet does not support network switching');
            }
        } catch (error) {
            console.error('Error switching wallet network:', error);
            alert('Please switch your wallet network manually to ' + network);
        }
    }

    // Fee configuration
    const FEE_ACCOUNT = new solanaWeb3.PublicKey('6zkf4DviZZkpWVEh53MrcQV6vGXGpESnNXgAvU6KpBUH');
    const FEES = {
        BASE_TOKEN_CREATION: 0.01,      // Base fee for token creation
        REVOKE_MINT: 0.005,            // Additional fee for revoking mint authority
        FREEZE_AUTHORITY: 0.005,       // Additional fee for adding freeze authority
        CUSTOM_DECIMALS: 0.005,        // Additional fee for custom decimals
        METADATA: 0.01                 // Additional fee for adding metadata
    };

    async function calculateTotalFee(options) {
        let totalFee = FEES.BASE_TOKEN_CREATION;
        
        if (options.revokeMint) totalFee += FEES.REVOKE_MINT;
        if (options.freezeAuthority) totalFee += FEES.FREEZE_AUTHORITY;
        if (options.customDecimals) totalFee += FEES.CUSTOM_DECIMALS;
        if (options.metadata) totalFee += FEES.METADATA;
        
        return totalFee;
    }

    async function createToken() {
        if (!currentWallet || !walletPublicKey) {
            alert('Please connect your wallet first');
            return;
        }

        try {
            const tokenName = document.getElementById('tokenName').value;
            const tokenSymbol = document.getElementById('tokenSymbol').value;
            const totalSupply = document.getElementById('totalSupply').value;
            const revokeMint = document.getElementById('revokeMint').checked;
            const freezeAuthority = document.getElementById('freezeAuthority').checked;
            const customDecimals = document.getElementById('customDecimals')?.checked || false;
            const metadata = document.getElementById('metadata')?.checked || false;

            // Calculate total fee based on selected options
            const totalFee = await calculateTotalFee({
                revokeMint,
                freezeAuthority,
                customDecimals,
                metadata
            });

            // Check if user has enough SOL for the fee
            const balance = await connection.getBalance(new solanaWeb3.PublicKey(walletPublicKey));
            const minimumRequired = solanaWeb3.LAMPORTS_PER_SOL * (totalFee + 0.01); // Fee + minimum for transaction
            
            if (balance < minimumRequired) {
                alert(`Insufficient balance. You need at least ${totalFee + 0.01} SOL for this operation.\n\n` +
                      `Fee breakdown:\n` +
                      `- Base token creation: ${FEES.BASE_TOKEN_CREATION} SOL\n` +
                      `${revokeMint ? `- Revoke mint authority: ${FEES.REVOKE_MINT} SOL\n` : ''}` +
                      `${freezeAuthority ? `- Freeze authority: ${FEES.FREEZE_AUTHORITY} SOL\n` : ''}` +
                      `${customDecimals ? `- Custom decimals: ${FEES.CUSTOM_DECIMALS} SOL\n` : ''}` +
                      `${metadata ? `- Metadata: ${FEES.METADATA} SOL\n` : ''}` +
                      `Total: ${totalFee} SOL`);
                return;
            }

            // Create fee transfer instruction
            const feeInstruction = solanaWeb3.SystemProgram.transfer({
                fromPubkey: new solanaWeb3.PublicKey(walletPublicKey),
                toPubkey: FEE_ACCOUNT,
                lamports: totalFee * solanaWeb3.LAMPORTS_PER_SOL
            });

            // Create token
            const mintAccount = solanaWeb3.Keypair.generate();
            const transaction = await createTokenTransaction(
                mintAccount,
                tokenName,
                tokenSymbol,
                totalSupply,
                revokeMint,
                freezeAuthority,
                customDecimals,
                metadata
            );

            // Combine fee transfer and token creation into a single transaction
            const combinedTransaction = new solanaWeb3.Transaction()
                .add(feeInstruction)
                .add(transaction);

            // Sign and send the transaction
            const signature = await currentWallet.signAndSendTransaction(combinedTransaction);
            
            console.log('Transaction sent:', signature);
            alert(`Token created successfully!\nTransaction signature: ${signature}\n\nTotal fee paid: ${totalFee} SOL`);

            // Store created token info
            const createdTokens = JSON.parse(localStorage.getItem('createdTokens') || '[]');
            createdTokens.push({
                name: tokenName,
                symbol: tokenSymbol,
                mint: mintAccount.publicKey.toString(),
                options: {
                    revokeMint,
                    freezeAuthority,
                    customDecimals,
                    metadata
                },
                feePaid: totalFee,
                timestamp: Date.now()
            });
            localStorage.setItem('createdTokens', JSON.stringify(createdTokens));

        } catch (error) {
            console.error('Error creating token:', error);
            alert('Failed to create token: ' + error.message);
        }
    }

    // Create token transaction
    async function createTokenTransaction(mintAccount, tokenName, tokenSymbol, totalSupply, revokeMint, freezeAuthority, customDecimals, metadata) {
        try {
            const mintRent = await connection.getMinimumBalanceForRentExemption(solanaWeb3.MINT_LAYOUT.span);
            const userPubKey = new solanaWeb3.PublicKey(walletPublicKey);

            // Create mint account
            const createAccountInstruction = solanaWeb3.SystemProgram.createAccount({
                fromPubkey: userPubKey,
                newAccountPubkey: mintAccount.publicKey,
                lamports: mintRent,
                space: solanaWeb3.MINT_LAYOUT.span,
                programId: solanaWeb3.TOKEN_PROGRAM_ID
            });

            // Initialize mint
            const initMintInstruction = solanaWeb3.Token.createInitializeMintInstruction(
                solanaWeb3.TOKEN_PROGRAM_ID,
                mintAccount.publicKey,
                9, // decimals
                userPubKey,
                freezeAuthority ? userPubKey : null
            );

            // Create associated token account for the user
            const associatedTokenAccount = await solanaWeb3.Token.getAssociatedTokenAddress(
                solanaWeb3.ASSOCIATED_TOKEN_PROGRAM_ID,
                solanaWeb3.TOKEN_PROGRAM_ID,
                mintAccount.publicKey,
                userPubKey
            );

            const createAssociatedAccountInstruction = solanaWeb3.Token.createAssociatedTokenAccountInstruction(
                solanaWeb3.ASSOCIATED_TOKEN_PROGRAM_ID,
                solanaWeb3.TOKEN_PROGRAM_ID,
                mintAccount.publicKey,
                associatedTokenAccount,
                userPubKey,
                userPubKey
            );

            // Mint tokens to the associated account
            const mintToInstruction = solanaWeb3.Token.createMintToInstruction(
                solanaWeb3.TOKEN_PROGRAM_ID,
                mintAccount.publicKey,
                associatedTokenAccount,
                userPubKey,
                [],
                totalSupply * (10 ** 9) // Convert to smallest units (9 decimals)
            );

            // Build transaction
            const transaction = new solanaWeb3.Transaction()
                .add(createAccountInstruction)
                .add(initMintInstruction)
                .add(createAssociatedAccountInstruction)
                .add(mintToInstruction);

            if (revokeMint) {
                // Add instruction to revoke mint authority
                transaction.add(
                    solanaWeb3.Token.createSetAuthorityInstruction(
                        solanaWeb3.TOKEN_PROGRAM_ID,
                        mintAccount.publicKey,
                        null,
                        'MintTokens',
                        userPubKey,
                        []
                    )
                );
            }

            // Get recent blockhash
            const { blockhash } = await connection.getRecentBlockhash();
            transaction.recentBlockhash = blockhash;
            transaction.feePayer = userPubKey;

            // Add mint account as signer
            transaction.sign(mintAccount);

            return transaction;
        } catch (error) {
            console.error('Error creating token transaction:', error);
            throw new Error('Failed to create token transaction: ' + error.message);
        }
    }

    function updateFeePreview() {
        const revokeMint = document.getElementById('revokeMint').checked;
        const freezeAuthority = document.getElementById('freezeAuthority').checked;
        const customDecimals = document.getElementById('customDecimals').checked;
        const metadata = document.getElementById('metadata').checked;

        // Update fee line items visibility
        document.getElementById('revokeMintFee').className = 
            `flex justify-between mb-1 ${revokeMint ? 'text-gray-900' : 'text-gray-400'}`;
        document.getElementById('freezeFee').className = 
            `flex justify-between mb-1 ${freezeAuthority ? 'text-gray-900' : 'text-gray-400'}`;
        document.getElementById('decimalsFee').className = 
            `flex justify-between mb-1 ${customDecimals ? 'text-gray-900' : 'text-gray-400'}`;
        document.getElementById('metadataFee').className = 
            `flex justify-between mb-1 ${metadata ? 'text-gray-900' : 'text-gray-400'}`;

        // Calculate total fee
        let totalFee = FEES.BASE_TOKEN_CREATION;
        if (revokeMint) totalFee += FEES.REVOKE_MINT;
        if (freezeAuthority) totalFee += FEES.FREEZE_AUTHORITY;
        if (customDecimals) totalFee += FEES.CUSTOM_DECIMALS;
        if (metadata) totalFee += FEES.METADATA;

        document.getElementById('totalFee').textContent = `${totalFee.toFixed(3)} SOL`;
    }

    // Add event listeners for fee preview updates
    document.addEventListener('DOMContentLoaded', () => {
        updateFeePreview();
    });
</script>

<div id="modal-container"></div>
</body>
</html>